function K = covMaterniso3FDI(hyp, x, z, ii)

if nargin<2, K = '2'; return; end                  % report number of parameters
if nargin<3, z = []; end                                   % make sure, z exists
xeqz = numel(z)==0; dg = strcmp(z,'diag') && numel(z)>0;        % determine mode
if nargin<4, ii = 0; end                                      % derivative index

% number of data and dimensions
[n, d] = size(x);

if dg
    K = covMaterniso(3, hyp, x, z);
else
    if xeqz
        %           |F(n)|D1(n)|D2(n)|D3(n)|
        % K = ---------------------
        %     F(n)  | FF,   FD1,  FD2,  FD3 
        %     D1(n) |  -,  D1D1, D1D2, D1D3
        %     D2(n) |  -,     -, D2D2, D2D3
        %     D3(n) |  -,     -,    -, D3D3
        
        K = zeros(n*(d + 1), n*(d + 1));
        for row = 0:d
            idx_row = n*row+1:n*(row+1);
            for col = row:d
                idx_col = n*col+1:n*(col+1);
                if row == 0
                    if col == 0
                        % F-F
                        if ii == 0,	K(idx_row, idx_col) = covMaterniso(3, hyp, x);
                        else        K(idx_row, idx_col) = covMaterniso(3, hyp, x, [], ii); end
                    else
                        % F-D
                        K(idx_row, idx_col) = covMaterniso3FD(hyp, x, x, col, ii);
                    end
                else
                        % D-D
                        K(idx_row, idx_col) = covMaterniso3DD(hyp, x, row, x, col, ii);
                end

                % transpose
                if row ~= col
                    K(idx_col, idx_row) = K(idx_row, idx_col)';
                end
            end
        end
    else
        %           |F(m)|
        % K = -----------
        %     F(n)  | FF
        %     D1(n) | D1F
        %     D2(n) | D2F
        %     D3(n) | D3F
        
        [m, d] = size(z);
        K = zeros(n*(d + 1), m);
        for row = 0:d
            idx_row = n*row+1:n*(row+1);
            if row == 0
                % F-F
                if ii == 0,	K(idx_row, :) = covMaterniso(3, hyp, x, z);
                else        K(idx_row, :) = covMaterniso(3, hyp, x, z, ii); end
            else
                % D-F
                K(idx_row, :) = covMaterniso3FD(hyp, z, x, row, ii)';
            end
        end
    end
end